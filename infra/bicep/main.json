{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "languageVersion": "2.0",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.37.4.10188",
      "templateHash": "14226268757273540452"
    }
  },
  "parameters": {
    "environmentName": {
      "type": "string",
      "metadata": {
        "description": "Azure Developer CLI environment name (maps to azd-env-name tag)."
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Azure region for all resources."
      }
    },
    "serviceName": {
      "type": "string",
      "defaultValue": "api",
      "metadata": {
        "description": "Service name used for azd-service-name tag on Container Apps."
      }
    },
    "tags": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "Optional tags applied to every resource."
      }
    },
    "postgresAdminPassword": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Administrator password for PostgreSQL flexible server. Generated by preprovision hook if not provided."
      }
    },
    "todoDbPassword": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Password for the application database user (todo_user). Generated by preprovision hook if not provided."
      }
    },
    "todoDbUser": {
      "type": "string",
      "defaultValue": "todo_user",
      "metadata": {
        "description": "Application database user name."
      }
    },
    "imageRepository": {
      "type": "string",
      "defaultValue": "fastapi-reference-arch/api-dev",
      "metadata": {
        "description": "Container image repository path inside ACR (e.g., fastapi-reference-arch/api-dev)."
      }
    },
    "imageTag": {
      "type": "string",
      "defaultValue": "latest",
      "metadata": {
        "description": "Container image tag to deploy (e.g., git SHA or dev)."
      }
    },
    "image": {
      "type": "string",
      "defaultValue": "mcr.microsoft.com/azuredocs/containerapps-helloworld:latest",
      "metadata": {
        "description": "Optional full image reference (registry/repo:tag). When set, overrides repository/tag concatenation. Defaults to public sample image to allow first provision before custom image exists."
      }
    },
    "environmentVariables": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "Optional array of environment variables applied to the container app. Each entry should include name/value or name/secretRef."
      }
    }
  },
  "variables": {
    "resourceToken": "[uniqueString(subscription().id, resourceGroup().id, parameters('location'), parameters('environmentName'))]",
    "baseTags": "[union(parameters('tags'), createObject('azd-env-name', parameters('environmentName')))]"
  },
  "resources": {
    "identityModule": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('identityModule-{0}', uniqueString('identityModule', deployment().name))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "environmentName": {
            "value": "[parameters('environmentName')]"
          },
          "resourceToken": {
            "value": "[variables('resourceToken')]"
          },
          "tags": {
            "value": "[variables('baseTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "3990725627853099422"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "environmentName": {
              "type": "string"
            },
            "resourceToken": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            }
          },
          "variables": {
            "identityName": "[format('azmid{0}', parameters('resourceToken'))]"
          },
          "resources": [
            {
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2023-01-31",
              "name": "[variables('identityName')]",
              "location": "[parameters('location')]",
              "tags": "[union(parameters('tags'), createObject('azd-env-name', parameters('environmentName')))]"
            }
          ],
          "outputs": {
            "identityId": {
              "type": "string",
              "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityName'))]"
            },
            "clientId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityName')), '2023-01-31').clientId]"
            },
            "principalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityName')), '2023-01-31').principalId]"
            }
          }
        }
      }
    },
    "registryModule": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('registryModule-{0}', uniqueString('registryModule', deployment().name))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "environmentName": {
            "value": "[parameters('environmentName')]"
          },
          "resourceToken": {
            "value": "[variables('resourceToken')]"
          },
          "tags": {
            "value": "[variables('baseTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "14497261735343738420"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "environmentName": {
              "type": "string"
            },
            "resourceToken": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            },
            "sku": {
              "type": "string",
              "defaultValue": "Basic",
              "allowedValues": [
                "Basic",
                "Standard",
                "Premium"
              ]
            }
          },
          "variables": {
            "registryName": "[format('azacr{0}', parameters('resourceToken'))]"
          },
          "resources": [
            {
              "type": "Microsoft.ContainerRegistry/registries",
              "apiVersion": "2023-11-01-preview",
              "name": "[variables('registryName')]",
              "location": "[parameters('location')]",
              "tags": "[union(parameters('tags'), createObject('azd-env-name', parameters('environmentName')))]",
              "sku": {
                "name": "[parameters('sku')]"
              },
              "properties": {
                "adminUserEnabled": false,
                "publicNetworkAccess": "Enabled"
              }
            }
          ],
          "outputs": {
            "registryId": {
              "type": "string",
              "value": "[resourceId('Microsoft.ContainerRegistry/registries', variables('registryName'))]"
            },
            "loginServer": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ContainerRegistry/registries', variables('registryName')), '2023-11-01-preview').loginServer]"
            }
          }
        }
      }
    },
    "monitoringModule": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('monitoringModule-{0}', uniqueString('monitoringModule', deployment().name))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "environmentName": {
            "value": "[parameters('environmentName')]"
          },
          "resourceToken": {
            "value": "[variables('resourceToken')]"
          },
          "tags": {
            "value": "[variables('baseTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "12814300792021263498"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "environmentName": {
              "type": "string"
            },
            "resourceToken": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            }
          },
          "variables": {
            "workspaceName": "[format('azlog{0}', parameters('resourceToken'))]",
            "appInsightsName": "[format('azapp{0}', parameters('resourceToken'))]"
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2022-10-01",
              "name": "[variables('workspaceName')]",
              "location": "[parameters('location')]",
              "tags": "[union(parameters('tags'), createObject('azd-env-name', parameters('environmentName')))]",
              "properties": {
                "retentionInDays": 30,
                "features": {
                  "enableLogAccessUsingOnlyResourcePermissions": true
                }
              }
            },
            {
              "type": "Microsoft.Insights/components",
              "apiVersion": "2020-02-02",
              "name": "[variables('appInsightsName')]",
              "location": "[parameters('location')]",
              "kind": "web",
              "tags": "[union(parameters('tags'), createObject('azd-env-name', parameters('environmentName')))]",
              "properties": {
                "Application_Type": "web",
                "WorkspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName'))]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName'))]"
              ]
            }
          ],
          "outputs": {
            "logAnalyticsId": {
              "type": "string",
              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName'))]"
            },
            "logAnalyticsCustomerId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName')), '2022-10-01').customerId]"
            },
            "appInsightsConnectionString": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Insights/components', variables('appInsightsName')), '2020-02-02').ConnectionString]"
            },
            "appInsightsInstrumentationKey": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Insights/components', variables('appInsightsName')), '2020-02-02').InstrumentationKey]"
            }
          }
        }
      }
    },
    "postgresModule": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('postgresModule-{0}', uniqueString('postgresModule', deployment().name))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "environmentName": {
            "value": "[parameters('environmentName')]"
          },
          "resourceToken": {
            "value": "[variables('resourceToken')]"
          },
          "tags": {
            "value": "[variables('baseTags')]"
          },
          "administratorPassword": {
            "value": "[parameters('postgresAdminPassword')]"
          },
          "publicNetworkAccess": {
            "value": "Enabled"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "11493768451411651069"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "environmentName": {
              "type": "string"
            },
            "resourceToken": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            },
            "skuName": {
              "type": "string",
              "defaultValue": "Standard_B1ms",
              "metadata": {
                "description": "SKU name for Azure Database for PostgreSQL Flexible Server (e.g., Standard_B1ms)."
              }
            },
            "serverVersion": {
              "type": "string",
              "defaultValue": "16",
              "allowedValues": [
                "13",
                "14",
                "15",
                "16"
              ],
              "metadata": {
                "description": "Server version to deploy."
              }
            },
            "storageSizeGb": {
              "type": "int",
              "defaultValue": 32,
              "metadata": {
                "description": "Storage size (GB)."
              }
            },
            "backupRetentionDays": {
              "type": "int",
              "defaultValue": 7,
              "metadata": {
                "description": "Number of days to retain backups."
              }
            },
            "geoRedundantBackup": {
              "type": "string",
              "defaultValue": "Disabled",
              "allowedValues": [
                "Enabled",
                "Disabled"
              ]
            },
            "administratorLogin": {
              "type": "string",
              "defaultValue": "pgadmin",
              "metadata": {
                "description": "Admin login used for password-based access."
              }
            },
            "administratorPassword": {
              "type": "securestring",
              "metadata": {
                "description": "Admin password supplied via azd secret or pipeline variable. Not stored in source control."
              }
            },
            "publicNetworkAccess": {
              "type": "string",
              "defaultValue": "Enabled",
              "allowedValues": [
                "Enabled",
                "Disabled"
              ],
              "metadata": {
                "description": "Enable or disable public network access (Enabled to use firewall allow lists)."
              }
            }
          },
          "variables": {
            "serverName": "[format('azpgs{0}', parameters('resourceToken'))]"
          },
          "resources": [
            {
              "type": "Microsoft.DBforPostgreSQL/flexibleServers",
              "apiVersion": "2024-08-01",
              "name": "[variables('serverName')]",
              "location": "[parameters('location')]",
              "tags": "[union(parameters('tags'), createObject('azd-env-name', parameters('environmentName')))]",
              "sku": {
                "name": "[parameters('skuName')]",
                "tier": "Burstable"
              },
              "properties": {
                "administratorLogin": "[parameters('administratorLogin')]",
                "administratorLoginPassword": "[parameters('administratorPassword')]",
                "version": "[parameters('serverVersion')]",
                "backup": {
                  "backupRetentionDays": "[parameters('backupRetentionDays')]",
                  "geoRedundantBackup": "[parameters('geoRedundantBackup')]"
                },
                "storage": {
                  "storageSizeGB": "[parameters('storageSizeGb')]"
                },
                "network": {
                  "publicNetworkAccess": "[parameters('publicNetworkAccess')]"
                },
                "highAvailability": {
                  "mode": "Disabled"
                },
                "authConfig": {
                  "activeDirectoryAuth": "Disabled",
                  "passwordAuth": "Enabled"
                }
              }
            },
            {
              "type": "Microsoft.DBforPostgreSQL/flexibleServers/firewallRules",
              "apiVersion": "2024-08-01",
              "name": "[format('{0}/{1}', variables('serverName'), 'AllowAll')]",
              "properties": {
                "startIpAddress": "0.0.0.0",
                "endIpAddress": "255.255.255.255"
              },
              "dependsOn": [
                "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers', variables('serverName'))]"
              ],
              "metadata": {
                "description": "Firewall rule to allow all IPs for development. Restrict in production."
              }
            }
          ],
          "outputs": {
            "serverId": {
              "type": "string",
              "value": "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers', variables('serverName'))]"
            },
            "serverName": {
              "type": "string",
              "value": "[variables('serverName')]"
            },
            "fullyQualifiedDomainName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.DBforPostgreSQL/flexibleServers', variables('serverName')), '2024-08-01').fullyQualifiedDomainName]"
            }
          }
        }
      }
    },
    "keyVaultModule": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('keyVaultModule-{0}', uniqueString('keyVaultModule', deployment().name))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "environmentName": {
            "value": "[parameters('environmentName')]"
          },
          "resourceToken": {
            "value": "[variables('resourceToken')]"
          },
          "tags": {
            "value": "[variables('baseTags')]"
          },
          "userAssignedIdentityPrincipalId": {
            "value": "[reference('identityModule').outputs.principalId.value]"
          },
          "todoDbPassword": {
            "value": "[parameters('todoDbPassword')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "2944056550733284640"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "environmentName": {
              "type": "string"
            },
            "resourceToken": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            },
            "userAssignedIdentityPrincipalId": {
              "type": "string"
            },
            "todoDbPassword": {
              "type": "securestring"
            }
          },
          "variables": {
            "keyVaultName": "[format('kv-{0}-{1}', parameters('environmentName'), take(parameters('resourceToken'), 8))]"
          },
          "resources": [
            {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2023-07-01",
              "name": "[variables('keyVaultName')]",
              "location": "[parameters('location')]",
              "tags": "[union(parameters('tags'), createObject('azd-env-name', parameters('environmentName')))]",
              "properties": {
                "tenantId": "[subscription().tenantId]",
                "sku": {
                  "family": "A",
                  "name": "standard"
                },
                "softDeleteRetentionInDays": 7,
                "publicNetworkAccess": "Enabled",
                "accessPolicies": [
                  {
                    "tenantId": "[subscription().tenantId]",
                    "objectId": "[parameters('userAssignedIdentityPrincipalId')]",
                    "permissions": {
                      "secrets": [
                        "Get",
                        "List"
                      ]
                    }
                  }
                ]
              }
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2023-07-01",
              "name": "[format('{0}/{1}', variables('keyVaultName'), 'todo-db-password')]",
              "properties": {
                "value": "[parameters('todoDbPassword')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]"
              ]
            }
          ],
          "outputs": {
            "keyVaultName": {
              "type": "string",
              "value": "[variables('keyVaultName')]"
            },
            "keyVaultId": {
              "type": "string",
              "value": "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]"
            },
            "keyVaultUri": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName')), '2023-07-01').vaultUri]"
            }
          }
        }
      },
      "dependsOn": [
        "identityModule"
      ]
    },
    "acaModule": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('acaModule-{0}', uniqueString('acaModule', deployment().name))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "environmentName": {
            "value": "[parameters('environmentName')]"
          },
          "resourceToken": {
            "value": "[variables('resourceToken')]"
          },
          "tags": {
            "value": "[variables('baseTags')]"
          },
          "serviceName": {
            "value": "[parameters('serviceName')]"
          },
          "logAnalyticsCustomerId": {
            "value": "[reference('monitoringModule').outputs.logAnalyticsCustomerId.value]"
          },
          "logAnalyticsWorkspaceId": {
            "value": "[reference('monitoringModule').outputs.logAnalyticsId.value]"
          },
          "registryLoginServer": {
            "value": "[reference('registryModule').outputs.loginServer.value]"
          },
          "userAssignedIdentityId": {
            "value": "[reference('identityModule').outputs.identityId.value]"
          },
          "secrets": {
            "value": [
              {
                "name": "db-password",
                "keyVaultUrl": "[format('{0}secrets/todo-db-password', reference('keyVaultModule').outputs.keyVaultUri.value)]",
                "identity": "[reference('identityModule').outputs.identityId.value]"
              }
            ]
          },
          "imageRepository": {
            "value": "[parameters('imageRepository')]"
          },
          "imageTag": {
            "value": "[parameters('imageTag')]"
          },
          "image": {
            "value": "[parameters('image')]"
          },
          "environmentVariables": {
            "value": "[concat(createArray(createObject('name', 'DB_AUTH_MODE', 'value', 'password'), createObject('name', 'DATABASE_HOST', 'value', reference('postgresModule').outputs.fullyQualifiedDomainName.value), createObject('name', 'DATABASE_PORT', 'value', '5432'), createObject('name', 'DATABASE_NAME', 'value', 'postgres'), createObject('name', 'DATABASE_USER', 'value', parameters('todoDbUser')), createObject('name', 'DATABASE_PASSWORD', 'secretRef', 'db-password'), createObject('name', 'APPLICATIONINSIGHTS_CONNECTION_STRING', 'value', reference('monitoringModule').outputs.appInsightsConnectionString.value), createObject('name', 'APP_ENV', 'value', parameters('environmentName')), createObject('name', 'LOG_LEVEL', 'value', 'INFO')), parameters('environmentVariables'))]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "18186555993685511211"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "environmentName": {
              "type": "string"
            },
            "resourceToken": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            },
            "serviceName": {
              "type": "string"
            },
            "logAnalyticsCustomerId": {
              "type": "string"
            },
            "logAnalyticsWorkspaceId": {
              "type": "string"
            },
            "registryLoginServer": {
              "type": "string"
            },
            "userAssignedIdentityId": {
              "type": "string"
            },
            "minReplicas": {
              "type": "int",
              "defaultValue": 0
            },
            "maxReplicas": {
              "type": "int",
              "defaultValue": 3
            },
            "containerCpu": {
              "type": "int",
              "defaultValue": 1
            },
            "containerMemory": {
              "type": "string",
              "defaultValue": "2Gi"
            },
            "targetPort": {
              "type": "int",
              "defaultValue": 8000
            },
            "secrets": {
              "type": "array",
              "defaultValue": []
            },
            "corsConfig": {
              "type": "object",
              "defaultValue": {
                "allowedOrigins": [
                  "*"
                ],
                "allowedMethods": [
                  "GET",
                  "POST",
                  "PUT",
                  "DELETE",
                  "OPTIONS",
                  "PATCH"
                ],
                "allowedHeaders": [
                  "*"
                ],
                "exposeHeaders": [
                  "*"
                ],
                "maxAge": 3600,
                "allowCredentials": false
              }
            },
            "environmentVariables": {
              "type": "array",
              "defaultValue": []
            },
            "imageRepository": {
              "type": "string",
              "defaultValue": "fastapi-reference-arch/api-dev",
              "metadata": {
                "description": "Container image repository path inside ACR (e.g., fastapi-reference-arch/api-dev)."
              }
            },
            "imageTag": {
              "type": "string",
              "defaultValue": "latest",
              "metadata": {
                "description": "Container image tag to deploy (e.g., git SHA or dev)."
              }
            },
            "image": {
              "type": "string",
              "defaultValue": "mcr.microsoft.com/azuredocs/containerapps-helloworld:latest",
              "metadata": {
                "description": "Optional full image reference (registry/repo:tag). When set, overrides repository/tag concatenation. Defaults to public sample image to allow first provision before custom image exists."
              }
            }
          },
          "variables": {
            "managedEnvironmentName": "[format('azace{0}', parameters('resourceToken'))]",
            "containerAppName": "[format('azaca{0}', parameters('resourceToken'))]"
          },
          "resources": [
            {
              "type": "Microsoft.App/managedEnvironments",
              "apiVersion": "2024-02-02-preview",
              "name": "[variables('managedEnvironmentName')]",
              "location": "[parameters('location')]",
              "tags": "[union(parameters('tags'), createObject('azd-env-name', parameters('environmentName')))]",
              "properties": {
                "appLogsConfiguration": {
                  "destination": "log-analytics",
                  "logAnalyticsConfiguration": {
                    "customerId": "[parameters('logAnalyticsCustomerId')]",
                    "sharedKey": "[listKeys(parameters('logAnalyticsWorkspaceId'), '2022-10-01').primarySharedKey]"
                  }
                },
                "workloadProfiles": [
                  {
                    "name": "consumption",
                    "workloadProfileType": "Consumption"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.App/containerApps",
              "apiVersion": "2024-02-02-preview",
              "name": "[variables('containerAppName')]",
              "location": "[parameters('location')]",
              "tags": "[union(parameters('tags'), createObject('azd-env-name', parameters('environmentName'), 'azd-service-name', parameters('serviceName')))]",
              "identity": {
                "type": "SystemAssigned, UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('userAssignedIdentityId'))]": {}
                }
              },
              "properties": {
                "managedEnvironmentId": "[resourceId('Microsoft.App/managedEnvironments', variables('managedEnvironmentName'))]",
                "configuration": {
                  "secrets": "[parameters('secrets')]",
                  "ingress": {
                    "external": true,
                    "targetPort": "[parameters('targetPort')]",
                    "transport": "Auto",
                    "corsPolicy": "[parameters('corsConfig')]"
                  },
                  "registries": [
                    {
                      "server": "[parameters('registryLoginServer')]",
                      "identity": "[parameters('userAssignedIdentityId')]"
                    }
                  ]
                },
                "template": {
                  "containers": [
                    {
                      "name": "[parameters('serviceName')]",
                      "image": "[if(not(equals(parameters('image'), '')), parameters('image'), format('{0}/{1}:{2}', parameters('registryLoginServer'), parameters('imageRepository'), parameters('imageTag')))]",
                      "resources": {
                        "cpu": "[parameters('containerCpu')]",
                        "memory": "[parameters('containerMemory')]"
                      },
                      "env": "[parameters('environmentVariables')]"
                    }
                  ],
                  "scale": {
                    "minReplicas": "[parameters('minReplicas')]",
                    "maxReplicas": "[parameters('maxReplicas')]"
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.App/managedEnvironments', variables('managedEnvironmentName'))]"
              ]
            }
          ],
          "outputs": {
            "containerAppId": {
              "type": "string",
              "value": "[resourceId('Microsoft.App/containerApps', variables('containerAppName'))]"
            },
            "containerAppPrincipalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.App/containerApps', variables('containerAppName')), '2024-02-02-preview', 'full').identity.principalId]"
            },
            "containerAppUrl": {
              "type": "string",
              "value": "[tryGet(tryGet(reference(resourceId('Microsoft.App/containerApps', variables('containerAppName')), '2024-02-02-preview').configuration, 'ingress'), 'fqdn')]"
            },
            "outboundIpAddresses": {
              "type": "array",
              "value": "[coalesce(reference(resourceId('Microsoft.App/containerApps', variables('containerAppName')), '2024-02-02-preview').outboundIpAddresses, createArray())]"
            },
            "managedEnvironmentId": {
              "type": "string",
              "value": "[resourceId('Microsoft.App/managedEnvironments', variables('managedEnvironmentName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "identityModule",
        "keyVaultModule",
        "monitoringModule",
        "postgresModule",
        "registryModule"
      ]
    },
    "rbacModule": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('rbacModule-{0}', uniqueString('rbacModule', deployment().name))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "acrId": {
            "value": "[reference('registryModule').outputs.registryId.value]"
          },
          "userAssignedIdentityPrincipalId": {
            "value": "[reference('identityModule').outputs.principalId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "10813869751688471948"
            }
          },
          "parameters": {
            "acrId": {
              "type": "string"
            },
            "userAssignedIdentityPrincipalId": {
              "type": "string"
            }
          },
          "variables": {
            "acrPullRoleId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '7f951dda-4ed3-4680-a7ca-43fe172d538d')]",
            "acrName": "[last(split(parameters('acrId'), '/'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.ContainerRegistry/registries/{0}', variables('acrName'))]",
              "name": "[guid(parameters('acrId'), parameters('userAssignedIdentityPrincipalId'), 'acr-pull')]",
              "properties": {
                "principalId": "[parameters('userAssignedIdentityPrincipalId')]",
                "roleDefinitionId": "[variables('acrPullRoleId')]",
                "principalType": "ServicePrincipal"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "identityModule",
        "registryModule"
      ]
    }
  },
  "outputs": {
    "RESOURCE_GROUP_ID": {
      "type": "string",
      "value": "[resourceGroup().id]"
    },
    "AZURE_CONTAINER_REGISTRY_ENDPOINT": {
      "type": "string",
      "value": "[reference('registryModule').outputs.loginServer.value]"
    },
    "CONTAINER_APP_FQDN": {
      "type": "string",
      "value": "[reference('acaModule').outputs.containerAppUrl.value]"
    },
    "CONTAINER_APP_ID": {
      "type": "string",
      "value": "[reference('acaModule').outputs.containerAppId.value]"
    },
    "POSTGRES_FQDN": {
      "type": "string",
      "value": "[reference('postgresModule').outputs.fullyQualifiedDomainName.value]"
    },
    "POSTGRES_DB": {
      "type": "string",
      "value": "postgres"
    },
    "MANAGED_IDENTITY_CLIENT_ID": {
      "type": "string",
      "value": "[reference('identityModule').outputs.clientId.value]"
    },
    "MANAGED_IDENTITY_PRINCIPAL_ID": {
      "type": "string",
      "value": "[reference('identityModule').outputs.principalId.value]"
    },
    "KEYVAULT_NAME": {
      "type": "string",
      "value": "[reference('keyVaultModule').outputs.keyVaultName.value]"
    },
    "KEYVAULT_URI": {
      "type": "string",
      "value": "[reference('keyVaultModule').outputs.keyVaultUri.value]"
    },
    "APPLICATIONINSIGHTS_CONNECTION_STRING": {
      "type": "string",
      "value": "[reference('monitoringModule').outputs.appInsightsConnectionString.value]"
    }
  }
}